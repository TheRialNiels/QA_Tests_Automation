AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
    CodeStarConnectionSSMParameter:
        Type: String
        Default: /qa-tests-automation/codebuild/codestar-connection-arn
        Description: SSM Parameter name that stores the CodeStar Connection ARN
    NotificationEmails:
        Type: CommaDelimitedList
        Description: Email addresses to receive build notifications
        Default: "admin@example.com"

Resources:
    ReportsBucket:
        Type: AWS::S3::Bucket
        Properties:
            BucketName: !Sub '${AWS::StackName}-qa-reports'
            WebsiteConfiguration:
                IndexDocument: index.html
            PublicAccessBlockConfiguration:
                BlockPublicAcls: false
                BlockPublicPolicy: false
                IgnorePublicAcls: false
                RestrictPublicBuckets: false

    ReportsBucketPolicy:
        Type: AWS::S3::BucketPolicy
        Properties:
            Bucket: !Ref ReportsBucket
            PolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: Allow
                      Principal: '*'
                      Action: s3:GetObject
                      Resource: !Sub '${ReportsBucket.Arn}/*'

    BuildNotificationsTopic:
        Type: AWS::SNS::Topic
        Properties:
            DisplayName: 'Build Notifications'
            TopicName: qa-tests-automation

    EmailSubscription:
        Type: AWS::SNS::Subscription
        Properties:
            Protocol: email
            TopicArn: !Ref BuildNotificationsTopic
            Endpoint: !Select [0, !Ref NotificationEmails]

    BuildProject:
        Type: AWS::CodeBuild::Project
        Properties:
            Name: qa-tests-automation
            Source:
                Type: GITHUB
                Location: https://github.com/TheRialNiels/QA_Test
            Environment:
                ComputeType: BUILD_GENERAL1_SMALL
                Image: aws/codebuild/standard:6.0
                Type: LINUX_CONTAINER
                EnvironmentVariables:
                    - Name: REPORTS_BUCKET
                      Value: !Ref ReportsBucket
                    - Name: COMMAND
                      Value: test.example
            Artifacts:
                Type: NO_ARTIFACTS
            ServiceRole: !GetAtt CodeBuildRole.Arn

    CodeBuildRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: codebuild.amazonaws.com
                      Action: sts:AssumeRole
            Policies:
                - PolicyName: CodeBuildPolicy
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Effect: Allow
                            Action:
                                - logs:*
                                - sns:Publish
                                - s3:PutObject
                                - s3:PutObjectAcl
                            Resource:
                                - '*'
                                - !Sub '${ReportsBucket.Arn}/*'
                          - Effect: Allow
                            Action:
                                - codestar-connections:UseConnection
                                - codestar-connections:GetConnectionToken
                            Resource: !Sub '{{resolve:ssm:${CodeStarConnectionSSMParameter}:1}}'

    BuildFailureAlarm:
        Type: AWS::CloudWatch::Alarm
        Properties:
            AlarmDescription: 'Alarm when tests automation fails'
            Namespace: AWS/CodeBuild
            MetricName: FailedBuilds
            Dimensions:
                - Name: ProjectName
                  Value: !Ref BuildProject
            Statistic: Sum
            Period: 300
            EvaluationPeriods: 1
            Threshold: 1
            ComparisonOperator: GreaterThanOrEqualToThreshold
            AlarmActions:
                - !Ref BuildNotificationsTopic

    BuildSuccessAlarm:
        Type: AWS::CloudWatch::Alarm
        Properties:
            AlarmDescription: 'Alarm when tests automation succeeds'
            Namespace: AWS/CodeBuild
            MetricName: SucceededBuilds
            Dimensions:
                - Name: ProjectName
                  Value: !Ref BuildProject
            Statistic: Sum
            Period: 300
            EvaluationPeriods: 1
            Threshold: 1
            ComparisonOperator: GreaterThanOrEqualToThreshold
            AlarmActions:
                - !Ref BuildNotificationsTopic

Outputs:
    ReportsBucketURL:
        Description: 'Static website URL to access test reports'
        Value: !Sub 'http://${ReportsBucket}.s3-website-${AWS::Region}.amazonaws.com'
